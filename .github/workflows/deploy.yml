name: Deploy Terraform on OCI (minimal)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      TF_WORKING_DIR: Terraform                # Ensure this matches the folder name
      OCI_KEY_FILE: /tmp/oci_key.pem

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Write OCI API private key
        run: |
          printf '%s\n' "${{ secrets.OCI_PRIVATE_KEY }}" > "$OCI_KEY_FILE"
          chmod 600 "$OCI_KEY_FILE"

      - name: Export OCI env vars
        run: |
          echo "OCI_TENANCY=${{ secrets.OCI_TENANCY_OCID }}" >> $GITHUB_ENV
          echo "OCI_USER=${{ secrets.OCI_USER_OCID }}" >> $GITHUB_ENV
          echo "OCI_FINGERPRINT=${{ secrets.OCI_FINGERPRINT }}" >> $GITHUB_ENV
          echo "OCI_REGION=${{ secrets.OCI_REGION }}" >> $GITHUB_ENV
          echo "OCI_KEY_FILE=$OCI_KEY_FILE" >> $GITHUB_ENV
          echo "TF_VAR_compartment_id=${{ secrets.OCI_COMPARTMENT_OCID }}" >> $GITHUB_ENV
          echo "TF_VAR_ssh_public_key='${{ secrets.SSH_PUBLIC_KEY }}'" >> $GITHUB_ENV

      - name: Debug Environment Variables
        run: |
          OCI_TENANCY=${{ secrets.OCI_TENANCY_OCID }}
          OCI_USER=${{ secrets.OCI_USER_OCID }}
          OCI_REGION=${{ secrets.OCI_REGION }}
          TF_VAR_COMPARTMENT_ID=${{ secrets.OCI_COMPARTMENT_OCID }}
          
          echo "OCI_TENANCY=$OCI_TENANCY"
          echo "OCI_USER=$OCI_USER"
          echo "OCI_REGION=$OCI_REGION"
          echo "TF_VAR_COMPARTMENT_ID=$TF_VAR_COMPARTMENT_ID"

      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Apply
        run: terraform apply -auto-approve
        working-directory: ${{ env.TF_WORKING_DIR }}