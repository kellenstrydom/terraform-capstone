name: Deploy Terraform on OCI

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      TF_WORKING_DIR: Terraform
      OCI_KEY_FILE: /tmp/oci_key.pem

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Write OCI API private key
        run: |
          printf '%s\n' "${{ secrets.OCI_PRIVATE_KEY }}" > "$OCI_KEY_FILE"
          chmod 600 "$OCI_KEY_FILE"

      - name: Export OCI env vars
        run: |
          echo "OCI_TENANCY_OCID=${{ secrets.OCI_TENANCY_OCID }}" >> $GITHUB_ENV
          echo "OCI_USER_OCID=${{ secrets.OCI_USER_OCID }}" >> $GITHUB_ENV
          echo "OCI_FINGERPRINT=${{ secrets.OCI_FINGERPRINT }}" >> $GITHUB_ENV
          echo "OCI_REGION=${{ secrets.OCI_REGION }}" >> $GITHUB_ENV
          echo "OCI_PRIVATE_KEY_PATH=$OCI_KEY_FILE" >> $GITHUB_ENV

          echo "TF_VAR_compartment_id=${{ secrets.OCI_COMPARTMENT_OCID }}" >> $GITHUB_ENV
          echo "TF_VAR_ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" >> $GITHUB_ENV

      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Apply
        run: terraform apply -auto-approve
        working-directory: ${{ env.TF_WORKING_DIR }}

              - name: Get instance IP from Terraform output
        run: |
          ip=$(terraform output -raw instance_public_ip)
          echo "INSTANCE_IP=$ip" >> $GITHUB_ENV
          echo "Instance IP from Terraform: $ip"
        working-directory: ${{ env.TF_WORKING_DIR }}

            - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Write SSH private key for Ansible
        run: |
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/ansible_key.pem
          chmod 600 /tmp/ansible_key.pem

      - name: Run Ansible playbook
        run: |
          echo "Using INSTANCE_IP=$INSTANCE_IP"
          ansible-playbook \
            -i "$INSTANCE_IP," \
            -u ubuntu \
            --private-key /tmp/ansible_key.pem \
            ansible/playbook.yml

