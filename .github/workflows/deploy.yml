name: Deploy Terraform on OCI

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      TF_WORKING_DIR: Terraform
      OCI_KEY_FILE: /tmp/oci_key.pem

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Write OCI private key to runner
        run: |
          # preserve newlines reliably
          printf '%s\n' "${{ secrets.OCI_PRIVATE_KEY }}" > "$OCI_KEY_FILE"
          chmod 600 "$OCI_KEY_FILE"

      - name: Export OCI env vars for Terraform
        run: |
          echo "OCI_TENANCY=${{ secrets.OCI_TENANCY_OCID }}" >> $GITHUB_ENV
          echo "OCI_USER=${{ secrets.OCI_USER_OCID }}" >> $GITHUB_ENV
          echo "OCI_FINGERPRINT=${{ secrets.OCI_FINGERPRINT }}" >> $GITHUB_ENV
          echo "OCI_REGION=${{ secrets.OCI_REGION }}" >> $GITHUB_ENV
          echo "OCI_KEY_FILE=$OCI_KEY_FILE" >> $GITHUB_ENV

      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Apply
        run: terraform apply -auto-approve
        working-directory: ${{ env.TF_WORKING_DIR }}