name: Deploy OCI Instance with Terraform and Configure with Ansible

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  terraform_ansible_deploy:
    runs-on: ubuntu-latest
    
    # Define environment variables
    env:
      TF_WORKING_DIR: Terraform
      ANSIBLE_WORKING_DIR: Ansible
      SSH_KEY_FILE: /tmp/oci_ssh_key.pem # Defines a temporary file path for the key

    steps:
      - name: Checkout Repository Code
        uses: actions/checkout@v4

      - name: Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3

      # --- OCI AUTHENTICATION STEP (For Terraform) ---
      - name: OCI Authentication using API Key
        uses: oracle-actions/auth-oci@v1
        with:
          user-ocid: ${{ secrets.OCI_USER_OCID }}
          tenancy-ocid: ${{ secrets.OCI_TENANCY_OCID }}
          fingerprint: ${{ secrets.OCI_FINGERPRINT }}
          private-key: ${{ secrets.OCI_PRIVATE_KEY }}
          region: ${{ secrets.OCI_REGION }}
          
      # -----------------------------------------------
      
      # --- SETUP: Write Private Key for SSH/Ansible ---
      # This step writes the secret content to a file, which Ansible needs.
      - name: Write SSH Private Key File
        run: |
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ${{ env.SSH_KEY_FILE }}
          chmod 600 ${{ env.SSH_KEY_FILE }} # Set secure permissions
      
      # --- SETUP: Install Ansible on the Runner (Control Node) ---
      - name: Install Ansible on Runner
        run: pip install ansible

      # --- TERRAFORM PROVISIONING STEPS ---
      - name: Terraform Init
        run: terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Validate
        run: terraform validate
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Plan
        run: terraform plan
        working-directory: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Apply & Capture IP
        id: apply_and_output
        run: |
          terraform apply -auto-approve
          
          # Capture the public IP outputted from your main.tf
          INSTANCE_IP=$(terraform output -raw instance_public_ip)
          
          # Set the IP as an output variable for the next step to use
          echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
        working-directory: ${{ env.TF_WORKING_DIR }} 
        
      # --- ANSIBLE CONFIGURATION STEP ---
      - name: Wait for SSH and Run Ansible Playbook
        id: ansible_config
        run: |
          INSTANCE_IP="${{ steps.apply_and_output.outputs.instance_ip }}"
          
          echo "Checking SSH connectivity to $INSTANCE_IP..."
          
          # 1. Wait for SSH availability using a robust retry loop (more reliable than a long sleep)
          MAX_RETRIES=10
          RETRY_COUNT=0
          
          # Use the temporary key file created earlier
          until ssh -i ${{ env.SSH_KEY_FILE }} -o StrictHostKeyChecking=no -o ConnectTimeout=5 opc@$INSTANCE_IP exit; do
            if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
              echo "Error: SSH not available after $MAX_RETRIES retries."
              exit 1
            fi
            echo "SSH not yet available. Retrying in 10s..."
            sleep 10
            RETRY_COUNT=$((RETRY_COUNT+1))
          done
          
          echo "SSH connection established. Running configuration playbook..."
          
          # 2. Run Ansible Playbook from the GitHub Runner (Control Node)
          ansible-playbook \
            -i "${INSTANCE_IP}," \
            --user opc \
            --private-key ${{ env.SSH_KEY_FILE }} \
            ${{ env.ANSIBLE_WORKING_DIR }}/install_nginx.yml